/* Generates ~190 Red Cross / Red Crescent "one-per-country" entries
   using the IFRC GO Admin Country CSV dataset. */

import fs from "node:fs";
import path from "node:path";

const OUT_PATH = path.join(process.cwd(), "data", "ifrcCharities.ts");

// IFRC GO Admin dataset (countries + national society info)
const CSV_URL =
  "https://goadmin.ifrc.org/api/v2/country/?format=csv&limit=500&ordering=society_name";

function parseCsv(text) {
  // Small CSV parser (handles quotes + commas inside quotes)
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"' && inQuotes && next === '"') {
      cur += '"';
      i++;
      continue;
    }
    if (ch === '"') {
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) {
      row.push(cur);
      cur = "";
      continue;
    }
    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (cur.length || row.length) row.push(cur);
      if (row.length) rows.push(row);
      row = [];
      cur = "";
      if (ch === "\r" && next === "\n") i++; // CRLF
      continue;
    }
    cur += ch;
  }

  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }

  return rows;
}

function slugify(str) {
  return String(str || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)+/g, "");
}

function normalizeUrl(url) {
  if (!url) return "";
  const u = url.trim();
  if (!u) return "";
  if (u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u.replace(/^\/+/, "");
}

async function main() {
  console.log("Downloading IFRC country CSV...");
  const res = await fetch(CSV_URL);

  if (!res.ok) {
    throw new Error(`CSV fetch failed: ${res.status} ${res.statusText}`);
  }

  const csvText = await res.text();
  const rows = parseCsv(csvText);
  const header = rows[0];
  const data = rows.slice(1);

  const idx = (name) => header.indexOf(name);

  const iCountryName = idx("name");
  const iSocietyName = idx("society_name");
  const iSocietyUrl = idx("society_url");
  const iIfcUrl = idx("url_ifrc");

  if (iCountryName === -1 || iSocietyName === -1) {
    console.log("Header columns:", header);
    throw new Error("CSV format changed: missing name/society_name columns.");
  }

  const today = new Date().toISOString().slice(0, 10);

  const charities = [];
  const seenSlugs = new Set();

  for (const r of data) {
    const country = (r[iCountryName] || "").trim();
    const societyName = (r[iSocietyName] || "").trim();
    const societyUrl = normalizeUrl(r[iSocietyUrl] || "");
    const ifrcUrl = normalizeUrl(r[iIfcUrl] || "");

    if (!country || !societyName) continue;

    let slug = slugify(`${societyName}-${country}`);
    if (!slug) continue;

    let k = 2;
    while (seenSlugs.has(slug)) slug = `${slug}-${k++}`;
    seenSlugs.add(slug);

    charities.push({
      slug,
      name: societyName,
      description: `Official Red Cross / Red Crescent National Society for ${country}. Provides humanitarian support, disaster response, and community services.`,
      country,
      city: "",
      category: "Emergency Relief",
      donateUrl: societyUrl || ifrcUrl, // default to official site link
      websiteUrl: societyUrl || undefined,
      verified: false,
      lastUpdated: today,
    });
  }

  const file = `// AUTO-GENERATED â€” do not hand edit.
// Generated by scripts/generate-ifrc-charities.mjs

export const ifrcCharities = ${JSON.stringify(charities, null, 2)} as const;
`;

  fs.mkdirSync(path.dirname(OUT_PATH), { recursive: true });
  fs.writeFileSync(OUT_PATH, file, "utf8");

  console.log(`Wrote ${charities.length} charities -> ${OUT_PATH}`);
  console.log("Next: import ifrcCharities into data/charities.ts");
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
